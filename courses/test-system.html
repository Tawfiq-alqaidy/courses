<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار النظام - Course Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; }
        .test-card { 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); 
            margin-bottom: 2rem;
        }
        .test-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px 15px 0 0;
        }
        .result-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
        }
        .test-btn {
            margin: 0.5rem;
            border-radius: 8px;
        }
        .success-indicator { color: #28a745; }
        .error-indicator { color: #dc3545; }
        .info-indicator { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="test-card">
            <div class="test-header text-center">
                <h1 class="mb-3">
                    <i class="bx bx-test-tube me-2"></i>
                    اختبار نظام إدارة الدورات
                </h1>
                <p class="mb-0">اختبار الوظائف الأساسية للنظام</p>
            </div>
            
            <div class="p-4">
                <!-- System Status -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h4><i class="bx bx-info-circle me-2"></i>حالة النظام</h4>
                        <div id="systemStatus" class="result-box">
                            جاري فحص النظام...
                        </div>
                    </div>
                </div>
                
                <!-- Test Buttons -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h4><i class="bx bx-play-circle me-2"></i>اختبارات النظام</h4>
                        <div class="d-flex flex-wrap">
                            <button class="btn btn-primary test-btn" onclick="runTest('dashboard')">
                                <i class="bx bx-dashboard me-1"></i>لوحة التحكم
                            </button>
                            <button class="btn btn-success test-btn" onclick="runTest('courses')">
                                <i class="bx bx-book me-1"></i>الدورات
                            </button>
                            <button class="btn btn-info test-btn" onclick="runTest('categories')">
                                <i class="bx bx-category me-1"></i>التصنيفات
                            </button>
                            <button class="btn btn-warning test-btn" onclick="runTest('applications')">
                                <i class="bx bx-file-blank me-1"></i>الطلبات
                            </button>
                            <button class="btn btn-secondary test-btn" onclick="testWaitingList()">
                                <i class="bx bx-time me-1"></i>قائمة الانتظار
                            </button>
                            <button class="btn btn-dark test-btn" onclick="testApplication()">
                                <i class="bx bx-send me-1"></i>تقديم طلب
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Test Results -->
                <div class="row">
                    <div class="col-12">
                        <h4><i class="bx bx-list-ul me-2"></i>نتائج الاختبارات</h4>
                        <div id="testResults" class="result-box">
                            انقر على أي زر أعلاه لبدء الاختبار...
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="row mt-4">
                    <div class="col-12 text-center">
                        <button class="btn btn-outline-primary" onclick="clearResults()">
                            <i class="bx bx-trash me-1"></i>مسح النتائج
                        </button>
                        <button class="btn btn-outline-success" onclick="runAllTests()">
                            <i class="bx bx-play me-1"></i>تشغيل جميع الاختبارات
                        </button>
                        <a href="demo-application-form.html" class="btn btn-primary">
                            <i class="bx bx-external-link me-1"></i>نموذج التقديم
                        </a>
                        <a href="demo-admin-dashboard.html" class="btn btn-secondary">
                            <i class="bx bx-cog me-1"></i>لوحة التحكم
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let testCount = 0;
        
        // Check system status on load
        document.addEventListener('DOMContentLoaded', function() {
            checkSystemStatus();
        });
        
        async function checkSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            try {
                const response = await fetch('test-api.php?action=test');
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.innerHTML = `
                        <div class="success-indicator">✅ النظام يعمل بشكل طبيعي</div>
                        <div class="mt-2">
                            <strong>إصدار PHP:</strong> ${data.data.php_version}<br>
                            <strong>الوقت:</strong> ${data.data.timestamp}<br>
                            <strong>الرسالة:</strong> ${data.data.message}
                        </div>
                        <div class="mt-3">
                            <strong>نتائج الاختبار الأولي:</strong>
                            <ul class="mt-2">
                                <li>حالة الدورة 1: <span class="info-indicator">${data.data.test_results.course_1_status}</span></li>
                                <li>حالة الدورة 2: <span class="info-indicator">${data.data.test_results.course_2_status}</span></li>
                                <li>إحصائيات: ${data.data.test_results.statistics.total_applications} طلب، ${data.data.test_results.statistics.registered} مسجل، ${data.data.test_results.statistics.waiting} في الانتظار</li>
                            </ul>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `<div class="error-indicator">❌ خطأ: ${data.message}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="error-indicator">❌ خطأ في الاتصال: ${error.message}</div>`;
            }
        }
        
        async function runTest(action) {
            const resultsDiv = document.getElementById('testResults');
            testCount++;
            
            addResult(`🧪 الاختبار #${testCount}: ${getActionName(action)}`);
            addResult('⏳ جاري التحميل...');
            
            try {
                const response = await fetch(`test-api.php?action=${action}`);
                const data = await response.json();
                
                if (data.success) {
                    addResult(`✅ نجح الاختبار: ${getActionName(action)}`);
                    addResult(`📊 البيانات المستلمة: ${JSON.stringify(data.data, null, 2)}`);
                } else {
                    addResult(`❌ فشل الاختبار: ${data.message}`);
                }
            } catch (error) {
                addResult(`❌ خطأ في الشبكة: ${error.message}`);
            }
            
            addResult('─'.repeat(50));
        }
        
        async function testWaitingList() {
            addResult(`🧪 الاختبار #${++testCount}: اختبار قائمة الانتظار`);
            
            try {
                // Test promotion from waiting list for course 2 (which is full)
                const response = await fetch('test-api.php?action=promote&course_id=2');
                const data = await response.json();
                
                if (data.success) {
                    addResult('✅ تم اختبار ترقية الطالب من قائمة الانتظار');
                    addResult(`📝 ${data.message}`);
                    if (data.data) {
                        addResult(`👤 الطالب المرقى: ${data.data.student_name}`);
                    }
                } else {
                    addResult(`❌ خطأ: ${data.message}`);
                }
            } catch (error) {
                addResult(`❌ خطأ: ${error.message}`);
            }
            
            addResult('─'.repeat(50));
        }
        
        async function testApplication() {
            addResult(`🧪 الاختبار #${++testCount}: تقديم طلب جديد`);
            
            const sampleApplication = {
                student: {
                    name: 'طالب تجريبي',
                    email: 'test@example.com',
                    phone: '0551234567'
                },
                courses: [1, 3] // Laravel course and Marketing course
            };
            
            try {
                const response = await fetch('test-api.php?action=apply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(sampleApplication)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addResult('✅ تم تقديم الطلب بنجاح');
                    data.data.forEach(result => {
                        addResult(`📋 ${result.course_name}: ${result.status} (${result.student_code})`);
                        addResult(`   ${result.message}`);
                    });
                } else {
                    addResult(`❌ فشل تقديم الطلب: ${data.message}`);
                }
            } catch (error) {
                addResult(`❌ خطأ: ${error.message}`);
            }
            
            addResult('─'.repeat(50));
        }
        
        async function runAllTests() {
            addResult('🚀 بدء تشغيل جميع الاختبارات...\n');
            
            const tests = ['dashboard', 'courses', 'categories', 'applications'];
            
            for (const test of tests) {
                await runTest(test);
                await new Promise(resolve => setTimeout(resolve, 500)); // Small delay
            }
            
            await testWaitingList();
            await testApplication();
            
            addResult('🎉 تم الانتهاء من جميع الاختبارات!');
        }
        
        function addResult(message) {
            const resultsDiv = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            resultsDiv.innerHTML += `[${timestamp}] ${message}\n`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        function clearResults() {
            document.getElementById('testResults').innerHTML = 'تم مسح النتائج...\n';
            testCount = 0;
        }
        
        function getActionName(action) {
            const names = {
                'dashboard': 'لوحة التحكم',
                'courses': 'الدورات',
                'categories': 'التصنيفات',
                'applications': 'الطلبات'
            };
            return names[action] || action;
        }
    </script>
</body>
</html>
